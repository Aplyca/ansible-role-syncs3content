---
- name: "From S3: Downloading content"
  shell: "aws s3 sync s3://{{ syncs3content.from.storage.bucket }} . --profile {{ syncs3content.from.storage.profile }}"
  args:
    chdir: "{{ syncs3content.from.storage.dir }}"

- name: "From S3: Uncompress the DB"
  unarchive:
    src: "{{ syncs3content.from.storage.dir }}/{{ syncs3content.from.database.dir }}/{{ syncs3content.from.database.name }}.sql.tar.gz"
    dest: /tmp
    copy: no

- name: "From S3: DB replacements"
  replace:
    dest: "/tmp/{{ syncs3content.from.database.name }}.sql"
    regexp: "{{ item.regex }}"
    replace: "{{ item.replace }}"
  with_items: syncs3content.from.database.replacements

- name: "From S3: Import DB"
  become: yes
  mysql_db:
    name: "{{ syncs3content.from.database.name }}"
    state: import
    target: "/tmp/{{ syncs3content.from.database.name }}.sql"

- name: "From S3: Delete DB File"
  file:
    path: "/tmp/{{ syncs3content.from.database.name }}.sql"
    state: absent

- name: "From S3: Execute post commands, please wait ..."
  shell: "{{ item }}"
  with_items: syncs3content.from.post_commands
